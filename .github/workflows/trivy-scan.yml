name: Scan Docker Image with Trivy

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  scan:
    name: Scan Docker Image with Trivy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build -t your-image-name .

      - name: Install Trivy
        run: |
          echo "üõ†Ô∏è C√†i ƒë·∫∑t Trivy..."
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.4_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.4_Linux-64bit.deb

      - name: Scan Docker image with Trivy
        run: |
          echo "üîç B·∫Øt ƒë·∫ßu qu√©t image b·∫±ng Trivy..."
          trivy image --exit-code 1 --severity CRITICAL --format table --no-progress your-image-name > trivy_report.txt

          if [ $? -ne 0 ]; then
            echo "‚ùå Trivy ph√°t hi·ªán l·ªó h·ªïng CRITICAL. Pipeline s·∫Ω d·ª´ng l·∫°i!"
            echo "üîé B√°o c√°o chi ti·∫øt:"
            cat trivy_report.txt
            exit 1
          else
            echo "‚úÖ Kh√¥ng ph√°t hi·ªán l·ªó h·ªïng CRITICAL!"
          fi
